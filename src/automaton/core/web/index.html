<!DOCTYPE html>
<html>
<head>
  <title>debug page</title>
  <meta charset='utf-8'>
</head>
<body>
  <script type="text/javascript" src="https://cdn.rawgit.com/dcodeIO/protobuf.js/6.8.8/dist/protobuf.min.js"></script>

  <textarea id=".proto" rows="10" cols="80" align="right">
syntax = "proto3";

// --- protocol messages ---

message Protocol {
  bytes protocol_id = 1;
  repeated bytes file_names = 2;
  repeated bytes files = 3;
}

message ProtocolIDsList {
  repeated bytes protocol_ids = 1;
}

message ProtocolsList {
  repeated Protocol protocols = 1;
}

// -- node messages --

message Node {
  bytes id = 1;
  bytes protocol_id = 2;
  bytes address = 3;
}

message NodeID {
  bytes node_id = 1;
}

message NodeIdsList {
  repeated bytes node_ids = 1;
}

message NodesList {
  repeated Node nodes = 1;
}

message NodeCmdRequest {
  bytes node_id = 1;
  bytes cmd = 2;
  bytes params = 3;
}

message NodeCmdResponse {
  bytes response = 1;
}

message PeerIdsList {
  bytes node_id = 1;
  repeated uint32 peer_ids = 2;
}

message PeerAddressesList {
  bytes node_id = 1;
  repeated bytes peer_addresses = 2;
}

message PeersList {
  bytes node_id = 1;
  repeated Peer peers = 2;
}

message Peer {
  uint32 id = 1;
  bytes address = 2;
}
  </textarea>

  <button type="button" onclick="read_and_parse()">Read and parse</button>
  <br>


  <textarea id="create_msg" rows="10" cols="80">
{
    "Node": {
      "id": "1231j2",
      "protocol_id": "213123",
      "address": "theaddress"
    }
}
  </textarea>
  <button type="button" onclick="create_msg()">Create message in buffer</button>
  <br>


  <textarea id="buffer_to_json" rows="10" cols="80" align="right">
  </textarea>
  <button type="button" onclick="buffer_to_json()">buffer to json</button>
  <br>

  <textarea id="Send_command" rows="10" cols="80">
{
  "method" : "launch_node",
  "Msg" :  {
    "Node": {
      "id": "1231j2",
      "protocol_id": "213123",
      "address": "theaddress"
    }
  }
}
  </textarea>
  <button type="button" onclick="create_and_send_command()">Send command</button>
  <br>
    <script>
  parsed = false;

  function reqListener() {
    console.log(this.responseText);
  }

  function send_request(body) {
      var req =  new XMLHttpRequest();
      req.addEventListener("load", reqListener);
      req.open("POST", "http://127.0.0.1:33777");
      req.send(body);
  }


  function _arrayBufferToBase64( buffer ) {
      var binary = '';
      var bytes = new Uint8Array( buffer );
      var len = bytes.byteLength;
      for (var i = 0; i < len; i++) {
          binary += String.fromCharCode( bytes[ i ] );
      }
      return window.btoa( binary );
  }
  create_and_send_command()
  function create_and_send_command() {
    if(!parsed){
      read_and_parse();
    }
    var body = "{";
    var input = document.getElementById("Send_command").value;
    var input_json = JSON.parse(input);
    for(var k in input_json) {
      if(k == "method") {
        body += '"method": "' + input_json[k] + '", ';
      } else if (k == "Msg") {
        var proto_msg =  new_proto_msg(input_json[k]);
        console.log(proto_msg);
        body +=  '"msg": "' + _arrayBufferToBase64(proto_msg) + '"';
      }
      // console.log(body);
      // console.log(k);
      // console.log(input_json[k]);
    }
    body += "}";
    console.log(body);
    var req =  new XMLHttpRequest();
    req.addEventListener("load", reqListener);
    req.open("POST", "http://127.0.0.1:33777");
    //req.open("GET", "http://httpbin.org/get");
    req.send(body);

  }

  function new_proto_msg(json_data) {
    if(!parsed){
      read_and_parse();
    }
    console.log("logging json_data:")
    console.log(json_data);
    for(var k in json_data) {
      console.log(k);
      var msg = root.lookupType(k);
      var payload = json_data[k];
      var err = msg.verify(payload);
      if (err) {
        console.log("error when creating msg: " + err);
        return;
      }
      var message = msg.create(payload);
      var buffer = msg.encode(message).finish();
    }
    return buffer;
  }

  function create_msg() {
    if(!parsed){
      read_and_parse();
    }
    try {
      var input_str = document.getElementById("create_msg").value;
      var input_json = JSON.parse(input_str);
      for(var k in input_json) {
        var msg = root.lookupType(k);
        var payload = input_json[k];
        var err = msg.verify(payload);
        if (err) {
          document.getElementById("create_msg").value = err;
          return;
        }
        //Create
        var message = msg.create(payload);
        //Encode
        var buffer = msg.encode(message).finish();
        //Log and send
        console.log(buffer);
        send_request(buffer);
      }
    }
    catch(err) {
      document.getElementById("create_msg").value = err;
    }
  }


  function buffer_to_json(json) {
    if(!parsed){
      read_and_parse();
    }
    document.getElementById("buffer_to_json").value = root.toJSON(json);
  }

  function read_and_parse() {

    try {
      proto_contents = document.getElementById(".proto").value;
      parsed_proto = protobuf.parse(proto_contents)
      root = parsed_proto.root

      // Obtain a message type
      var Node = root.lookupType("Node");

      // Test error
      var payload = "invalid (not an object)";
      var err = Node.verify(payload);
      if (err) {
        console.log("error as intended")
      }

      // Exemplary payload
      var payload = { awesomeField: "AwesomeString" };

      // Verify the payload if necessary (i.e. when possibly incomplete or invalid)
      var errMsg = Node.verify(payload);
      if (errMsg)
          throw Error(errMsg);

      // Create a new message
      var message = Node.create(payload); // or use .fromObject if conversion is necessary

      // Encode a message to an Uint8Array (browser) or Buffer (node)
      var buffer = Node.encode(message).finish();
      // ... do something with buffer
      console.log(buffer);
      send_request(buffer);
      // Decode an Uint8Array (browser) or Buffer (node) to a message
      var message = Node.decode(buffer);
      // ... do something with message

      // If the application uses length-delimited buffers, there is also encodeDelimited and decodeDelimited.

      parsed = true;
    }
    catch(err) {
      document.getElementById("buffer_to_json").value = err;
    }
  }
  </script>
</body>
</html>
